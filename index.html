<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Input</title>
</head>
<body>
  <div style="text-align: center; font-family: sans-serif; background: #f0f0f0; padding: 60px;">
    <h2>Voice Assistant</h2>
    <p>Initializing microphone access...</p>
  </div>

  <script>
    let recognition;

    function startVoiceRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        sendError("Speech recognition not supported in this browser.");
        return;
      }

      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = "en-US";

      recognition.onstart = function () {
        document.body.innerHTML = `
          <div style="text-align: center; font-family: sans-serif; background: #eaffea; padding: 60px;">
            <h2>üé§ <strong>Listening...</strong></h2>
            <p>Say something...</p>
          </div>`;
        console.log("Speech recognition started.");
      };

      recognition.onresult = function (event) {
        console.log("Speech result event:", event);
        const transcript = event.results[0][0].transcript;
        sendTranscript(transcript);
      };

      recognition.onerror = function (event) {
        console.error("Speech recognition error:", event.error);
        sendError(event.error);
      };

      recognition.onend = function () {
        console.log("Speech recognition ended.");
        // If no speech was captured, show an error
        sendError("No speech detected or recognition ended too quickly.");
      };

      recognition.start();
    }

    function sendTranscript(transcript) {
      if (window.opener) {
        window.opener.postMessage({ type: 'voice-result', transcript }, "*");
      }
      window.close();
    }

    function sendError(error) {
      if (window.opener) {
        window.opener.postMessage({ type: 'voice-error', message: error }, "*");
      }
      document.body.innerHTML = `
        <div style="text-align: center; font-family: sans-serif; background: #ffeeee; padding: 60px;">
          <h2>‚ùå Error</h2>
          <p>${error}</p>
          <button onclick="startVoiceRecognition()">Try Again</button>
        </div>`;
    }

    startVoiceRecognition();
  </script>
</body>
</html>
